// Production Schema with Complete Relations
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["blytz_hire"]
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  role            String
  emailVerified   Boolean  @default(false)
  profileComplete Boolean  @default(false)
  lastSeenAt      DateTime @updatedAt
  preferences     Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  vaProfile     VAProfile?
  company       Company?
  notifications Notification[]
  payments      Payment[]

  @@map("users")
  @@schema("blytz_hire")
}

model VAProfile {
  id                    String             @id @default(cuid())
  userId                String             @unique
  name                  String
  bio                   String?
  country               String
  hourlyRate            Int
  skills                String[]
  availability          Boolean            @default(true)
  email                 String?
  phone                 String?
  timezone              String?
  languages             Json?
  workExperience        Json?
  education             Json?
  responseRate          Float?
  averageRating         Float?
  totalReviews          Int                @default(0)
  featuredProfile       Boolean            @default(false)
  profileViews          Int                @default(0)
  resumeUrl             String?
  videoIntroUrl         String?
  skillsScore           Int?
  verificationLevel     String             @default("basic")
  backgroundCheckPassed Boolean            @default(false)
  portfolioItems        PortfolioItem[]
  skillsAssessments     SkillsAssessment[]
  reviews               Review[]           @relation("vaReviews")
  badges                Badge[]
  featured              Boolean?           @default(false)
  earnedAmount          Float?             @default(0)
  completedJobs         Int                @default(0)
  avatarUrl             String?

  user       User        @relation(fields: [userId], references: [id])
  jobs       Job[]
  proposals  Proposal[]
  contracts  Contract[]
  timesheets Timesheet[]

  @@map("va_profiles")
  @@schema("blytz_hire")
}

model Company {
  id                    String   @id @default(cuid())
  userId                String   @unique
  name                  String
  bio                   String?
  country               String
  website               String?
  logoUrl               String?
  industry              String?
  companySize           String?
  foundedYear           Int?
  description           String?
  mission               String?
  values                Json?
  benefits              Json?
  email                 String?
  phone                 String?
  verificationLevel     String   @default("basic")
  backgroundCheckPassed Boolean  @default(false)
  featuredCompany       Boolean  @default(false)
  socialLinks           Json?
  techStack             Json?
  totalSpent            Float?   @default(0)
  updatedAt             DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id])
  jobPostings JobPosting[]
  reviews     Review[]     @relation("companyReviews")
  jobs        Job[]
  contracts   Contract[]

  @@map("companies")
  @@schema("blytz_hire")
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  data      Json?
  read      Boolean   @default(false)
  priority  String    @default("normal")
  channels  Json?
  expiresAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
  @@schema("blytz_hire")
}

model PortfolioItem {
  id           String   @id @default(cuid())
  vaProfileId  String
  title        String
  description  String
  fileUrl      String
  fileType     String
  thumbnailUrl String?
  category     String?
  technologies String[]
  featured     Boolean  @default(false)
  projectUrl   String?
  createdAt    DateTime @default(now())

  vaProfile VAProfile @relation(fields: [vaProfileId], references: [id])

  @@map("portfolio_items")
  @@schema("blytz_hire")
}

model SkillsAssessment {
  id             String    @id @default(cuid())
  vaProfileId    String
  skillName      String
  category       String
  score          Int
  difficulty     String
  assessmentType String
  completedAt    DateTime  @default(now())
  expiresAt      DateTime?

  vaProfile VAProfile @relation(fields: [vaProfileId], references: [id])

  @@map("skills_assessments")
  @@schema("blytz_hire")
}

model Badge {
  id          String    @id @default(cuid())
  vaProfileId String
  badgeType   String
  title       String
  description String
  icon        String
  level       String
  issuedAt    DateTime  @default(now())
  expiresAt   DateTime?

  vaProfile VAProfile @relation(fields: [vaProfileId], references: [id])

  @@map("badges")
  @@schema("blytz_hire")
}

model Review {
  id         String   @id @default(cuid())
  reviewerId String
  targetType String
  targetId   String
  rating     Int
  comment    String?
  categories Json?
  helpful    Int      @default(0)
  verified   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  vaProfile VAProfile? @relation("vaReviews", fields: [targetId], references: [id], map: "reviews_va_targetId_fkey")
  company   Company?   @relation("companyReviews", fields: [targetId], references: [id], map: "reviews_company_targetId_fkey")

  @@map("reviews")
  @@schema("blytz_hire")
}

model JobPosting {
  id               String   @id @default(cuid())
  companyId        String
  title            String
  description      String
  requirements     Json?
  responsibilities Json?
  benefits         Json?
  rateRange        String
  budget           Float?
  location         String?
  remote           Boolean  @default(true)
  category         String?
  tags             String[]
  experienceLevel  String?
  employmentType   String?
  jobType          String?  @default("fixed")
  duration         String?
  status           String?  @default("open")
  urgency          String?  @default("medium")
  skillsRequired   String[]
  toolsUsed        Json?
  teamSize         Int?
  reportingTo      String?
  travelRequired   String?
  workSchedule     Json?
  views            Int      @default(0)
  proposalCount    Int      @default(0)
  featured         Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  company   Company    @relation(fields: [companyId], references: [id])
  proposals Proposal[]
  jobs      Job[]
  contracts Contract[]

  @@map("job_postings")
  @@schema("blytz_hire")
}

model Job {
  id           String    @id @default(cuid())
  jobPostingId String
  vaProfileId  String
  companyId    String
  status       String    @default("pending")
  title        String
  description  String
  budget       Float?
  hourlyRate   Float?
  totalHours   Float?
  totalAmount  Float?
  startDate    DateTime?
  endDate      DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  jobPosting JobPosting  @relation(fields: [jobPostingId], references: [id])
  vaProfile  VAProfile   @relation(fields: [vaProfileId], references: [id])
  company    Company     @relation(fields: [companyId], references: [id])
  proposals  Proposal[]
  contracts  Contract[]
  milestones Milestone[]
  payments   Payment[]
  timesheets Timesheet[]

  @@map("jobs")
  @@schema("blytz_hire")
}

model Proposal {
  id             String    @id @default(cuid())
  jobPostingId   String
  vaProfileId    String
  jobId          String?
  coverLetter    String
  bidAmount      Float
  bidType        String    @default("fixed")
  hourlyRate     Float?
  estimatedHours Float?
  deliveryTime   String
  attachments    Json?
  status         String    @default("pending")
  viewedAt       DateTime?
  respondedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  jobPosting JobPosting @relation(fields: [jobPostingId], references: [id])
  vaProfile  VAProfile  @relation(fields: [vaProfileId], references: [id])
  job        Job?       @relation(fields: [jobId], references: [id])
  contracts  Contract[]

  @@map("proposals")
  @@schema("blytz_hire")
}

model Contract {
  id              String    @id @default(cuid())
  jobId           String
  jobPostingId    String
  vaProfileId     String
  companyId       String
  proposalId      String?
  contractType    String
  amount          Float
  hourlyRate      Float?
  currency        String    @default("USD")
  startDate       DateTime
  endDate         DateTime?
  status          String    @default("active")
  terms           Json?
  deliverables    Json[]
  milestonesData  Json[]
  paymentSchedule String?   @default("upon_completion")
  totalPaid       Float     @default(0)
  totalHours      Float?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  job        Job         @relation(fields: [jobId], references: [id])
  jobPosting JobPosting  @relation(fields: [jobPostingId], references: [id])
  vaProfile  VAProfile   @relation(fields: [vaProfileId], references: [id])
  company    Company     @relation(fields: [companyId], references: [id])
  proposal   Proposal?   @relation(fields: [proposalId], references: [id])
  payments   Payment[]
  milestones Milestone[]
  timesheets Timesheet[]

  @@map("contracts")
  @@schema("blytz_hire")
}

model Milestone {
  id          String    @id @default(cuid())
  contractId  String
  jobId       String
  title       String
  description String?
  amount      Float
  status      String    @default("pending")
  dueDate     DateTime?
  completedAt DateTime?
  approvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  contract Contract @relation(fields: [contractId], references: [id])
  job      Job      @relation(fields: [jobId], references: [id])

  @@map("milestones")
  @@schema("blytz_hire")
}

model Timesheet {
  id          String    @id @default(cuid())
  contractId  String
  vaProfileId String
  jobId       String
  date        DateTime
  startTime   DateTime
  endTime     DateTime
  totalHours  Float
  description String?
  status      String    @default("pending")
  approvedAt  DateTime?
  approvedBy  String? // User ID of approver
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  contract  Contract  @relation(fields: [contractId], references: [id])
  vaProfile VAProfile @relation(fields: [vaProfileId], references: [id])
  job       Job       @relation(fields: [jobId], references: [id])

  @@map("timesheets")
  @@schema("blytz_hire")
}

model Payment {
  id                    String    @id @default(cuid())
  jobId                 String? // For job payments
  contractId            String? // For contract payments
  milestoneId           String? // For milestone payments
  userId                String // Payer (company user)
  receiverId            String // Payee (VA user)
  stripePaymentIntentId String    @unique
  amount                Int // in cents
  status                String // "pending" | "processing" | "succeeded" | "failed" | "refunded"
  stripeFee             Int? // Stripe processing fee
  platformFee           Int? // Our platform fee
  method                String // "card" | "bank" | "crypto"
  type                  String    @default("payment") // "payment" | "refund" | "payout"
  metadata              Json? // Additional payment data
  refundAmount          Int? // Refund amount if any
  refundedAt            DateTime?
  processedAt           DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  job      Job?      @relation(fields: [jobId], references: [id])
  contract Contract? @relation(fields: [contractId], references: [id])
  user     User      @relation(fields: [userId], references: [id])

  @@map("payments")
  @@schema("blytz_hire")
}

model Invoice {
  id            String   @id @default(cuid())
  contractId    String
  userId        String // Company user who created the invoice
  receiverId    String // VA user who receives the invoice
  invoiceNumber String
  items         Json[]
  subtotal      Float
  taxRate       Float
  taxAmount     Float
  discount      Float
  totalAmount   Float
  dueDate       DateTime
  currency      String   @default("USD")
  status        String   @default("pending") // "pending" | "paid" | "overdue" | "cancelled"
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("invoices")
  @@schema("blytz_hire")
}
