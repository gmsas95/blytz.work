services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: blytz-backend
    restart: unless-stopped
    environment:
      NODE_ENV: $${{environment.NODE_ENV}}
      PORT: $${{environment.BACKEND_PORT}}
      DATABASE_URL: $${{environment.DATABASE_URL}}
      FIREBASE_PROJECT_ID: $${{environment.FIREBASE_PROJECT_ID}}
      FIREBASE_CLIENT_EMAIL: $${{environment.FIREBASE_CLIENT_EMAIL}}
      FIREBASE_PRIVATE_KEY: $${{environment.FIREBASE_PRIVATE_KEY}}
      STRIPE_SECRET_KEY: $${{environment.STRIPE_SECRET_KEY}}
      STRIPE_WEBHOOK_SECRET: $${{environment.STRIPE_WEBHOOK_SECRET}}
      JWT_SECRET: $${{environment.JWT_SECRET}}
      ALLOWED_ORIGINS: $${{environment.ALLOWED_ORIGINS}}
      PLATFORM_FEE_PERCENTAGE: $${{environment.PLATFORM_FEE_PERCENTAGE}}
      PAYMENT_AMOUNT: $${{environment.PAYMENT_AMOUNT}}
      LOG_LEVEL: $${{environment.LOG_LEVEL}}
    ports:
      - "3000:3000"

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.blytz-api.rule=Host(`gateway.blytz.work`)"
      - "traefik.http.routers.blytz-api.entrypoints=web,websecure"
      - "traefik.http.routers.blytz-api.tls=true"
      - "traefik.http.routers.blytz-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.blytz-api.middlewares=api-cors@file"
      - "traefik.http.services.blytz-api.loadbalancer.server.port=3000"
    networks:
      - blytz-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  blytz-network:
    driver: bridge
    external: false
