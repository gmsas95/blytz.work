version: '3.8'

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: $${{environment.NEXT_PUBLIC_API_URL}}
        NEXT_PUBLIC_APP_URL: $${{environment.NEXT_PUBLIC_APP_URL}}
        NEXT_PUBLIC_FIREBASE_PROJECT_ID: $${{environment.FIREBASE_PROJECT_ID}}
        NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: $${{environment.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}}
        NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: $${{environment.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}}
        NEXT_PUBLIC_FIREBASE_APP_ID: $${{environment.NEXT_PUBLIC_FIREBASE_APP_ID}}
        NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: $${{environment.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}}
    container_name: blytz-frontend
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_API_URL: $${{environment.NEXT_PUBLIC_API_URL}}
      NEXT_PUBLIC_APP_URL: $${{environment.NEXT_PUBLIC_APP_URL}}
      NEXT_PUBLIC_FIREBASE_PROJECT_ID: $${{environment.FIREBASE_PROJECT_ID}}
      NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: $${{environment.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}}
      NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: $${{environment.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}}
      NEXT_PUBLIC_FIREBASE_APP_ID: $${{environment.NEXT_PUBLIC_FIREBASE_APP_ID}}
      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: $${{environment.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}}
    depends_on:
      backend:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.blytz-frontend.rule=Host(`blytz.work`)"
      - "traefik.http.routers.blytz-frontend.entrypoints=web,websecure"
      - "traefik.http.routers.blytz-frontend.tls=true"
      - "traefik.http.routers.blytz-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.blytz-frontend.middlewares=redirect-to-https@file"
      - "traefik.http.services.blytz-frontend.loadbalancer.server.port=3000"
    networks:
      - blytz-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  blytz-network:
    driver: bridge
    external: false
